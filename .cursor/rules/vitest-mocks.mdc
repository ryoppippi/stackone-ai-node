---
description: Vitest testing mocks
globs: *.spec.ts
alwaysApply: false
---
# Vitest Mocks

This document outlines the standards for writing tests using Vitest in this repository.

## HTTP Request Mocking with MSW

### Prefer MSW Over fetch Mocking

**Always use MSW (Mock Service Worker) for mocking HTTP requests** instead of `vi.spyOn(globalThis, 'fetch')`.

MSW is already configured globally in `vitest.setup.ts`, so you don't need to set up the server in individual test files.

#### Adding Mock Handlers

Add your mock endpoints to `mocks/handlers.ts`:

```typescript
import { http, HttpResponse } from 'msw';

export const handlers = [
  http.get('https://api.example.com/endpoint', () => {
    return HttpResponse.json({ data: 'mock response' });
  }),
  // ... other handlers
];
```

#### Overriding Handlers in Tests

Use `server.use()` to override handlers for specific test cases:

```typescript
import { http, HttpResponse } from 'msw';
import { server } from '../../../mocks/node';

it('handles error responses', async () => {
  server.use(
    http.get('https://api.example.com/endpoint', () => {
      return HttpResponse.json({ error: 'Not found' }, { status: 404 });
    })
  );

  // Your test code here
});
```

The global `afterEach` hook in `vitest.setup.ts` automatically calls `server.resetHandlers()` to reset overrides.

#### Verifying Requests

Use MSW's event listeners to verify that requests were made:

```typescript
it('makes the expected request', async () => {
  const recordedRequests: Request[] = [];
  const listener = ({ request }: { request: Request }) => {
    recordedRequests.push(request);
  };
  server.events.on('request:start', listener);

  // Make your request
  await someFunction();

  expect(recordedRequests).toHaveLength(1);
  expect(recordedRequests[0]?.url).toBe('https://api.example.com/endpoint');

  server.events.removeListener('request:start', listener);
});
```

**Important:**
- Do NOT use `vi.spyOn(globalThis, 'fetch')` for HTTP mocking - use MSW instead
- Do NOT add `beforeAll`/`afterAll`/`afterEach` for MSW setup in test files - it's already configured globally
- MSW handlers are reset after each test automatically
- For tests that need to run their own servers (e.g., MCP servers), you may need to temporarily close and restart MSW

## File System Testing

### Use fs-fixture for File System Operations

For tests that need to work with the file system, use `fs-fixture` to create temporary test directories with automatic cleanup.

**IMPORTANT: Always use `await using` syntax - do NOT manually manage fixture lifecycle.**

```typescript
import { createFixture } from 'fs-fixture';

it('should save file to disk', async () => {
  await using fixture = await createFixture();
  await fixture.writeFile('data.json', JSON.stringify({ test: 'data' }));
  expect(await fixture.exists('data.json')).toBe(true);
});
```

**Reference:** See `node_modules/fs-fixture/README.md` for full API and advanced usage

## Mocking Best Practices

### Use Proper Mocking Functions

For non-HTTP mocking, use the appropriate mocking functions from Vitest:

- Use `vi.spyOn()` to track calls to existing functions without replacing their implementation
- Use `vi.fn()` to create standalone mock functions
- Use `vi.mock()` for module-level mocking

```typescript
// Good: Using vi.spyOn for existing methods
const spy = vi.spyOn(fs, "readFileSync");

// Good: Creating a standalone mock function
const mockFn = vi.fn(() => "mocked result");
```

### Restore Mocks After Tests

Always restore mocks after tests to prevent test pollution:

- Use `vi.restoreAllMocks()` in `afterEach` or `afterAll` hooks
- Alternatively, use `mockFn.mockRestore()` for individual mocks

```typescript
// Good: Restoring all mocks after each test
afterEach(() => {
  vi.restoreAllMocks();
});
```

### Use Test Lifecycle Hooks

Organise test setup and teardown using lifecycle hooks:

- Use `beforeEach` for setting up mocks and test data
- Use `afterEach` for cleaning up mocks and test data
- Use `afterAll` for final cleanup

```typescript
describe("MyClass", () => {
  let mySpy;

  beforeEach(() => {
    // Setup mocks
    mySpy = vi.spyOn(myObject, "myMethod");
  });

  afterEach(() => {
    // Clean up
    vi.restoreAllMocks();
  });

  // Tests go here
});
```

### Avoid Global Mocks

Avoid modifying global objects or prototypes directly. Instead:

- Use `vi.spyOn` to mock methods on objects
- Use `vi.mock()` to mock entire modules
- Keep mocks scoped to the tests that need them

```typescript
// Bad: Directly modifying a global object
fs.readFileSync = vi.fn();

// Good: Using vi.spyOn
const readFileSpy = vi.spyOn(fs, "readFileSync");
```

### Use Module Mocking Appropriately

When mocking modules:

- Use `vi.mock()` at the top of the test file (hoisted automatically)
- For dynamic mocking, use `vi.doMock()`
- Consider using `vi.importActual()` when you need partial mocks

```typescript
// Good: Module mocking
vi.mock("./myModule", () => {
  return {
    myFunction: () => "mocked result",
  };
});
```

### Verify Mock Interactions

Always verify that mocks were called as expected:

- Use `.toHaveBeenCalled()` to verify a function was called
- Use `.toHaveBeenCalledWith()` to verify arguments
- Use `.toHaveBeenCalledTimes()` to verify call count

```typescript
test("my function calls the dependency", () => {
  const spy = vi.spyOn(dependency, "method");
  myFunction();
  expect(spy).toHaveBeenCalled();
  expect(spy).toHaveBeenCalledWith("expected arg");
  expect(spy).toHaveBeenCalledTimes(1);
});
```

## Test Organisation

### Group Related Tests

Use `describe` blocks to group related tests:

```typescript
describe("MyClass", () => {
  describe("myMethod", () => {
    it("should handle valid input", () => {
      // Test with valid input
    });

    it("should handle invalid input", () => {
      // Test with invalid input
    });
  });
});
```

### Write Clear Test Descriptions

Test descriptions should clearly state what is being tested and the expected outcome:

```typescript
// Good: Clear test description
it("should return user data when given a valid user ID", () => {
  // Test implementation
});

// Bad: Vague test description
it("works correctly", () => {
  // Test implementation
});
```

## Additional Resources

- [Vitest Documentation](https://vitest.dev)
- [MSW Documentation](https://mswjs.io)
